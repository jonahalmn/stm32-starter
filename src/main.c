#include <stdio.h>
#include <math.h>
#include "sys/cm4.h"
#include "sys/devices.h"
#include "sys/init.h"
#include "sys/clock.h"
#include "systick.h"
#include "gpio.h"
/* #include "led.h" */
/* #include "button.h" */
/* #include "buzzer.h" */
#include "musique.h"
#include "dma_ctrl.h"
#include "dac.h"


/* Fonction permmetant de jouer une note */
/*
void jouer_note(uint32_t freq, uint32_t temps);
*/

volatile uint32_t time;
uint32_t tempo = 128;
uint32_t pulse;
uint32_t played_times;
uint32_t current_note;
uint8_t current_o;

/* Handler d'interruption systick - a decommenter ci-besoin */

void __attribute__((interrupt)) SysTick_Handler()
{
	time++;
}


/* Handler d'interruption du bouton sur PB8 - a decommenter ci-besoin */
/*
void __attribute__((interrupt)) EXTI9_5_Handler()
{
	EXTI.PR |= (1<<8);
}
*/


/* Handler d'interruption du bouton sur PC13 - a decommenter ci-besoin */
/*
void __attribute__((interrupt)) EXTI15_10_Handler()
{
	EXTI.PR |= (1<<13);  
}
*/
extern const Melodie morceau1;
extern const Melodie gamme;

const uint32_t LUT[128] = {0x8000,0x864,0x8c9,0x92d,0x990,0x9f2,0xa53,0xab2,
0xb10,0xb6c,0xbc5,0xc1d,0xc72,0xcc4,0xd13,0xd5f,
0xda8,0xded,0xe2f,0xe6d,0xea7,0xedd,0xf0e,0xf3b,
0xf64,0xf88,0xfa8,0xfc3,0xfd9,0xfea,0xff6,0xffe,
0x1000,0xffe,0xff6,0xfea,0xfd9,0xfc3,0xfa8,0xf88,
0xf64,0xf3b,0xf0e,0xedd,0xea7,0xe6d,0xe2f,0xded,
0xda8,0xd5f,0xd13,0xcc4,0xc72,0xc1d,0xbc5,0xb6c,
0xb10,0xab2,0xa53,0x9f2,0x990,0x92d,0x8c9,0x864,
0x800,0x79c,0x737,0x6d3,0x670,0x60e,0x5ad,0x54e,
0x4f0,0x494,0x43b,0x3e3,0x38e,0x33c,0x2ed,0x2a1,
0x258,0x213,0x1d1,0x193,0x159,0x123,0xf2,0xc5,
0x9c,0x78,0x58,0x3d,0x27,0x16,0xa,0x2,
0x0,0x2,0xa,0x16,0x27,0x3d,0x58,0x78,
0x9c,0xc5,0xf2,0x123,0x159,0x193,0x1d1,0x213,
0x258,0x2a1,0x2ed,0x33c,0x38e,0x3e3,0x43b,0x494,
0x4f0,0x54e,0x5ad,0x60e,0x670,0x6d3,0x737,0x79c};


const uint32_t LUT1[128] = {0x000,0x000,0x000,0x000,0x000,0x000,0x000,0x000,
0x000,0x000,0x000,0x000,0x000,0x000,0x000,0x000,
0x000,0x000,0x000,0x000,0x000,0x000,0x000,0x000,
0x000,0x000,0x000,0x000,0x000,0x000,0x000,0x000,
0x0000,0x000,0x000,0x000,0x000,0x000,0x000,0x000,
0x000,0x000,0x000,0x000,0x000,0x000,0x000,0x000,
0x000,0x000,0x000,0x000,0x000,0xfff,0xfff,0xfff,
0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,
0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,
0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,
0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,
0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,
0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,
0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,
0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,0xfff,0xfff};

int main()
{
	current_o = 0;
	time = 0;
	played_times = 0;
	current_note = 0;
	pulse = (1000 * 60)/(tempo * 4);
	/* Initialisation a decommenter en fonction du programme */
	enable_DMA1();
	enable_GPIOA();
	enable_GPIOB();
	enable_DAC();

	/* enable_GPIOC(); */
	setup_gpio_mode(&GPIOA, 5, MODER_GPO);
	write_gpio(&GPIOA, 5, 1);
	/* led_init(); */
	
	setup_gpio_mode(&GPIOA, 0, MODER_GPO);

	setup_gpio_mode(&GPIOB, 9, MODER_AF);
	setup_gpio_afr(&GPIOB, 9, 1);

	enable_TIM2();
	setup_timer_DMA(&TIM2, 2, 220, 0.001);
	setup_dma(&DMA1, 6, 3, DMA_M2P, DMA_PRIO_HI, 0, 1, DMA_SIZE_WORD, 1, 0);
	setup_dma_data(&DMA1, 6, &LUT, 128, &(TIM2.CCR2));

	toggle_timer(&TIM2);
	enable_dma(&DMA1, 6);

	//setup_dac(4);
	//start_dac();


	SysTick_init(1000);

	
	

	/* On initialise les IT BP et systick a 1ms */
	/* button_init(); */
	/* button_irq_init(); */
	
  
	/* On initilise le buzzer pilote par TIM2-CH2 */
	/* enable_TIM2();*/
	//buzzer_pwm_init(1000);
  
	printf("*** Welcome to Nucleo F446 ! ***\r\n");
	//play_note(morceau1.partition[current_note], 0.01);
	while(1){

		
		//print_dma();

		if(time > 500) {
			time = 0;
			current_o = ~current_o;
			write_gpio(&GPIOA, 0, current_o);
			//printf("hello %d", current_o);

			setup_gpio_mode(&GPIOA, 5, MODER_GPO);
			write_gpio(&GPIOA, 5, current_o);
		}

		//TIM2.EGR |= 1 << 6;
		printf("cc2: %d \n\r", TIM2.CCR2);

		// if(time > morceau1.partition[current_note].duree * pulse) {
		// 	current_note = (current_note + 1) % morceau1.nb_note;
		// 	//play_note(morceau1.partition[current_note], 0.01);
		// 	time = 0;
		// 	played_times++;
		// 	//setup_gpio_mode(&GPIOA, 0, MODER_GPO);
		// 	write_gpio(&GPIOA, 0, ~current_o);
		// 	printf("hello");
		// }

	};
	
	return 0;
}



